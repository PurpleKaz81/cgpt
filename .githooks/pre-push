#!/usr/bin/env bash
set -euo pipefail

remote_name="${1:-}"
remote_url="${2:-}"

blocked=0
# shellcheck disable=SC2034
while read -r local_ref local_sha remote_ref remote_sha; do
  [ -z "${remote_ref}" ] && continue
  if [ "${remote_ref}" = "refs/heads/main" ]; then
    echo "ERROR: direct push to main is blocked by local guardrail." >&2
    echo "Remote: ${remote_name} (${remote_url})" >&2
    echo "Use branch -> PR -> required checks -> merge." >&2
    blocked=1
  fi
done

if [ "${blocked}" -ne 0 ]; then
  exit 1
fi

exit 0
