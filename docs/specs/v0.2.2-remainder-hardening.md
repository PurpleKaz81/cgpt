# v0.2.2 Remaining Edge-Case Hardening Spec

Last updated: 2026-02-16

## Purpose

Capture the follow-up hardening scope that remained after `v0.2.1`, then define tests and release gates before implementation.

## Scope

In scope:

1. Extraction directory freshness on re-extract of the same ZIP stem.
2. `create_time` coercion in message extraction paths.
3. Deterministic and strict ChatGPT conversations JSON discovery.
4. `--context` bounds validation.
5. Empty normalized `--name` rejection.

Out of scope:

1. Provider-specific ingestion expansion (Gemini/Perplexity) in this patch.
2. New CLI flags unrelated to these edge-case remediations.

## Problem Statements

1. Re-extracting into an existing output directory can leave stale files from prior runs.
2. Direct `float(...)` conversions in message extraction can still crash on malformed message timestamps.
3. Fallback to largest arbitrary `*.json` can select unrelated JSON files.
4. `--context` currently accepts negative or extreme values with no guardrails.
5. `--name` can normalize to an empty slug and unexpectedly target the root dossiers directory.

## Intended Behavior Contracts

### Extraction Freshness Tests

- Extraction writes into a clean target tree for each run.
- Re-extracting the same ZIP stem does not preserve stale payload files from older extracts.

### Message Timestamp Coercion Tests

- Invalid message-level `create_time` values are coerced to `0.0`.
- Message extraction commands do not traceback due to malformed message timestamps.

### JSON Discovery

- Discovery should only resolve files that match expected ChatGPT conversations naming and structure.
- If no valid conversations JSON is found, command fails clearly instead of selecting arbitrary JSON.

### `--context` Validation

- `--context` must be a bounded integer.
- Negative values and extreme values are rejected with explicit CLI errors.

### `--name` Validation

- If `--name` normalizes to an empty slug, command fails with a clear validation error.
- Dossier output must never silently fall back to the root dossiers directory because of empty normalized names.

## Test Matrix

### Extraction Freshness

1. `test_extract_same_zip_stem_replaces_stale_files`

Expected behavior:

- Second extract for same stem does not leave first-run-only files.

### Message Timestamp Coercion

1. `test_quick_where_messages_tolerates_invalid_message_create_time`

Expected behavior:

- Command succeeds without traceback when message timestamps are malformed.

### JSON Discovery Strictness

1. `test_find_prefers_valid_conversations_json_over_larger_unrelated_json`
2. `test_build_dossier_fails_when_only_unrelated_json_exists`

Expected behavior:

- Valid conversations file is selected deterministically.
- Unrelated JSON does not get selected as export source.

### `--context` Bounds

1. `test_build_dossier_rejects_negative_context`
2. `test_quick_rejects_excessive_context`

Expected behavior:

- CLI exits non-zero with explicit range/validation guidance.

### `--name` Empty Slug

1. `test_build_dossier_rejects_name_that_normalizes_empty`

Expected behavior:

- Command exits non-zero with explicit `--name` validation error.

## Release Gate Checklist

1. New tests above are present and passing.
2. Existing test suites remain green.
3. `./scripts/release_check.sh` passes.
4. `README.md`, `TECHNICAL.md`, and `docs/specs/current-capabilities.md` are updated for behavior changes.
5. `CHANGELOG.md` includes release-notes entries for all user-visible changes.
