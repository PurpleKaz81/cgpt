# v0.2.1 Edge-Case Hardening Spec

Last updated: 2026-02-16

## Purpose

Define the decision-complete scope for a security and correctness hardening patch before implementation starts.

## Scope

In scope:

1. ZIP extraction path safety hardening (`extract`).
2. `quick --and` correctness for `--where messages` and `--where all`.
3. Invalid/non-numeric `create_time` resilience in time-based flows.
4. Explicit `--config` load/parse failures as hard errors.
5. UTF-8-family decoding hardening for `--ids-file`, `--patterns-file`, `--used-links-file`.

Out of scope:

1. Stale extraction directory cleanup behavior.
2. Empty slug/name handling changes.
3. JSON discovery heuristic redesign.
4. Broader selection UX rewrites unrelated to this bundle.

## Problem Statements

1. ZIP extraction currently trusts member paths and can be exposed to path traversal archives.
2. `quick --and` behavior is not strictly enforced for message and all-scope matching.
3. Time-based filtering/sorting paths can raise on malformed `create_time` values.
4. Some `--config` load failures are silently swallowed, producing misleading behavior.
5. Input files assume UTF-8 without explicit decode policy and clear failure messaging.

## Intended Behavior Contracts

### `extract` / `x`

- Validate all ZIP members before extraction.
- Reject unsafe members (parent traversal, absolute path, drive-rooted path, destination escape).
- On unsafe archive, fail fast, write nothing from that ZIP, and do not update `extracted/latest`.

### `quick` / `q`

- `--and --where messages`: all terms must match within message text scope.
- `--and --where all`: all terms must be satisfied across the union of title and message text.
- Default (without `--and`) keeps current OR semantics.

### Time-Based Flows

- Invalid/non-numeric timestamps are coerced to `0.0`.
- Commands continue without traceback.
- Emit warning summary once per command run on stderr when invalid timestamps are seen.

### `--config` Error Policy

- If `--config` is provided and loading/parsing fails, command exits non-zero.
- Error output must clearly identify file and failure reason.

### Input File Encoding Policy

- File-based inputs are read using UTF-8-family decoding (`utf-8-sig` accepted).
- Invalid encoding triggers non-zero exit with clear decode guidance.

## Test Matrix

### ZIP Safety

1. `test_extract_rejects_parent_traversal_member`
2. `test_extract_rejects_absolute_member`
3. `test_extract_rejects_windows_drive_member`
4. `test_extract_unsafe_zip_writes_nothing_and_does_not_update_latest`

Expected behavior:

- Non-zero exit with unsafe-member error.
- No payload writes.
- Latest pointer unchanged.

### `quick --and` Semantics

1. `test_quick_where_messages_and_requires_all_terms`
2. `test_quick_where_all_and_uses_union_scope_for_all_terms`
3. `test_quick_where_messages_without_and_keeps_or_behavior`

Expected behavior:

- Correct AND semantics in messages/all scopes.
- OR behavior preserved without `--and`.

### Timestamp Robustness

1. `test_recent_invalid_create_time_coerces_to_zero_and_warns`
2. `test_quick_recent_invalid_create_time_does_not_crash`
3. `test_quick_days_invalid_create_time_excluded_by_cutoff`

Expected behavior:

- No traceback.
- Warning summary on stderr.
- Deterministic filtering/sorting with invalid timestamps treated as `0.0`.

### Config Error Policy

1. `test_quick_fails_on_missing_config_file`
2. `test_build_dossier_fails_on_invalid_config_json`
3. `test_recent_fails_on_invalid_config_json`

Expected behavior:

- Non-zero exit with explicit config file error.

### Encoding/Input Files

1. `test_quick_ids_file_utf8_bom_is_supported`
2. `test_build_dossier_ids_file_invalid_encoding_fails_cleanly`
3. `test_quick_patterns_file_invalid_encoding_fails_cleanly`
4. `test_quick_used_links_file_invalid_encoding_fails_cleanly`

Expected behavior:

- BOM input accepted.
- Invalid encoding fails with decode guidance.

## Release Gate Checklist (This Patch)

1. New hardening tests pass.
2. Existing critical-path suite remains green.
3. `./scripts/release_check.sh` passes.
4. Docs guard remains green.
5. Capability and roadmap docs reflect shipped behavior after implementation.
6. Patch release `v0.2.1` is tagged and published.
