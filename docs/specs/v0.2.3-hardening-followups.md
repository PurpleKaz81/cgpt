# v0.2.3 Hardening Follow-Ups Spec

Last updated: 2026-02-16

## Purpose

Define and lock the next hardening bundle that remains after `v0.2.2`, with test-first acceptance criteria and release gates.

## Scope

In scope:

1. ZIP extraction hardening for special members and archive-size limits.
2. `create_time` coercion in working-index generation paths.
3. Explicit failure on missing optional file flags (`--patterns-file`, `--used-links-file`).
4. Strict config schema validation (unknown keys and wrong types).
5. Duplicate conversation ID detection in map-building paths.
6. JSON discovery scaling guardrails for large extraction trees.

Out of scope:

1. New provider ingestion features.
2. New user-facing command families.
3. SQLite/index schema redesign.

## Problem Statements

1. ZIP extraction blocks path traversal but still allows unbounded member count and uncompressed size, and does not explicitly reject symlink/special entries.
2. Working-index generation still performs raw `create_time` sorting/math in some paths and can misbehave on malformed values (for example strings).
3. Missing optional files for `--patterns-file` and `--used-links-file` can be silently ignored, hiding user mistakes.
4. Config loading validates JSON parse only; unknown keys and wrong-typed values pass through.
5. Duplicate conversation IDs in source data can silently overwrite earlier entries when maps are built.
6. Conversations JSON discovery can do expensive candidate parsing on very large trees.

## Intended Behavior Contracts

### ZIP Hardening

- Extraction rejects ZIP members that are symlinks or non-regular special entries.
- Extraction enforces bounded archive limits for member count and aggregate uncompressed bytes.
- On violation, extraction fails fast before writing payload files or updating `extracted/latest`.

### Working-Index Timestamp Coercion

- Working-index timeline and priority scoring paths coerce invalid `create_time` values to `0.0`.
- Dossier generation does not traceback due to malformed conversation timestamps.

### Optional File Flags

- If `--patterns-file` is provided and missing, command exits non-zero with explicit file error.
- If `--used-links-file` is provided and missing, command exits non-zero with explicit file error.

### Config Schema Validation

- Config root must be an object with only supported keys.
- Nested schema for known sections validates expected value types.
- Unknown keys or wrong-typed fields fail fast with clear validation errors.

### Duplicate ID Detection

- Duplicate conversation IDs in normalized export input fail fast before selection/build steps continue.
- Error output lists duplicate IDs.

### JSON Discovery Scaling

- Discovery retains deterministic priority order while using bounded candidate sets.
- Candidate parsing work is capped by per-priority shortlist limits to avoid unbounded growth on large trees.

## Test Matrix

### ZIP Hardening

1. `test_extract_rejects_symlink_member`
2. `test_extract_rejects_zip_member_count_over_limit`
3. `test_extract_rejects_zip_uncompressed_size_over_limit`

Expected behavior:

- Command exits non-zero with explicit ZIP hardening error.

### Working-Index Timestamp Coercion

1. `test_build_dossier_split_tolerates_string_create_time_in_working_index`

Expected behavior:

- Command succeeds and writes split output without traceback.

### Optional File Flags

1. `test_build_dossier_fails_on_missing_patterns_file`
2. `test_recent_fails_on_missing_patterns_file`
3. `test_quick_fails_on_missing_patterns_file`
4. `test_build_dossier_split_fails_on_missing_used_links_file`

Expected behavior:

- Command exits non-zero with explicit missing-file error.

### Config Schema Validation

1. `test_quick_fails_on_unknown_config_key`
2. `test_build_dossier_fails_on_wrong_typed_config_key`

Expected behavior:

- Command exits non-zero with schema-validation guidance.

### Duplicate ID Detection

1. `test_build_dossier_fails_on_duplicate_conversation_ids`
2. `test_make_dossiers_fails_on_duplicate_conversation_ids`

Expected behavior:

- Command exits non-zero and reports duplicate IDs.

### JSON Discovery Scaling

1. `test_find_conversations_json_limits_candidate_parsing_per_priority_bucket`

Expected behavior:

- Discovery remains correct while parse attempts are bounded by shortlist policy.

## Release Gate Checklist

1. New `v0.2.3` hardening tests are present and passing.
2. Existing test suites remain green.
3. `./scripts/release_check.sh` passes.
4. `README.md`, `TECHNICAL.md`, `docs/specs/current-capabilities.md`, and roadmap docs are synced with shipped behavior.
5. `CHANGELOG.md` and version metadata are updated for `v0.2.3`.
